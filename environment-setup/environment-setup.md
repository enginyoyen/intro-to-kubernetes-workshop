# Setup Workshop environment
Workshop environment consist of two kubernetes clusters and container registry:
* azure container registry: Which participant will store the image they build
* target-cluster: Which participant will interact via kubectl and deploy workload
* shell-cluster: Which a shell container prepared via kubectl to connect target-cluster. Shell container is exposed via nginx-ingress controller. 

![Environment Overview](img/environment-setup.png)

Shell over browser:
![Shell over browser](img/shell-sample.gif)


## Setting up the shell cluster

### Ingress Controller
Helm is used to install the nginx ingress controller.
```
helm upgrade --install ingress-nginx ingress-nginx \
  --repo https://kubernetes.github.io/ingress-nginx \
  --namespace ingress-nginx --create-namespace
```

## Setting up the namespace
Create a namespace called `k8s-shell` for all the shell resources:

```
kubectl create namespace k8s-shell
```


### TLS Certificate
TLS certificate for the sub-domain is generated by https://certbot.eff.org 

Certificate is generated by the certbox is On Mac with DNS challange:

```
brew install certbot
certbot certonly --manual --preferred-challenges dns
```

Certificate is stored in the shell cluster as secrets via:
```
kubectl create secret tls ey-cert \
  --key privkey.pem \
  --cert fullchain.pem \
  -n=k8s-shell
```

This secret will be used in the ingress setup.

### kubectl config and other workshop resources
The container image that will be deployed should have access to the target-cluster. Which means `kubectl config` file should be made available in the container. 

PS: THIS IS ONLY FOR TRAINING PURPOSES, IT IS NOT MEANT FOR PRODUCTION ENVIRONMENT. 

How to generate a valid kube-config file is your choice, once you retrieve config file you can create a secret containing kube config file.

```
kubectl create secret generic kube-config --from-file=config  -n=k8s-shell
```


Other resources that are needed for the workshop can be added as config-map

```
kubectl create cm workshop --from-file=workshop -n=k8s-shell
```

### Create HTTP Basic Auth Credentials
The terminal that is exposed over browser is enabled with HTTP Basic Authentication, just to have a minimal protection, which is meant to be used in the workshop period. Change the value `user:pass` to make something bit more harder to guess and create a new secret.

```
kubectl create secret generic terminal-credentials \
  --from-literal='CREDENTIAL=user:pass' \
  -n=k8s-shell
```

## Deploying shell
You do need to build the container image before, you can use the [Dockerfile](./Dockerfile) in this repository to build it. Once it is build, you can replace it the image url in the [shell.yaml](shell.yaml)

Add the image url add create the deployment and expose it as a service:
```
kubectl apply -f shell.yaml -n=k8s-shell
kubectl expose deployment shell -n=k8s-shell
```

Replace the host name in the [shell-ingress.yaml](shell-ingress.yaml) and create a ingress, now you should be able to launch the terminal over browser:
```
kubectl apply -f shell-ingress.yaml -n=k8s-shell
```



